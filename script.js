document.addEventListener("DOMContentLoaded",Y);const e="https://gist.githubusercontent.com/Thomas-Marchand/427d44e917d26d6073378d81db84d5b2/raw/calendar_events.json",t=6,n=21,s=60,o={M2:"#eb0909",M2_ANDROIDE:"#bf1e9a",MOSIMA:"#83d45b","AI-ADAPT":"#3498db",COCOMA:"#becc29",MADMC:"#f1c40f",MAOA:"#e67e22",AOTJ:"#e74c3c",MADI:"#ff365a",HAII:"#b368de",IAR:"#1f804f","OIP Gr1":"#ab1f8d","OIP Gr2":"#ab1f9d","OIP Gr3":"#ab1fad","DEEP-L":"#16304a",RDFIA:"#0b5345"},a=24,i=680;let c,l,d,r,u=[],m={},g=[],p={},f=0,y=0,h="",v=[],w="daily",E=0,D=!1;const L=document.getElementById("sidebar"),b=document.getElementById("sidebar-toggle-btn"),I=document.querySelector(".calendar-container"),k=document.getElementById("today-btn"),M=document.getElementById("daily-view-btn"),x=document.getElementById("weekly-view-btn"),$=document.getElementById("prev-btn"),C=document.getElementById("next-btn"),S=document.getElementById("last-updated"),B=document.getElementById("collapsed-sidebar-info"),A=document.getElementById("instruction-popup-overlay"),O=document.getElementById("instruction-popup-box"),N=document.getElementById("instruction-popup-close-btn"),T=document.getElementById("stale-popup-overlay"),H=document.getElementById("stale-popup-box"),P=document.getElementById("stale-popup-close-btn"),j=document.getElementById("event-detail-overlay"),F=document.getElementById("event-detail-box"),G=document.getElementById("event-detail-close-btn"),R=document.getElementById("event-detail-title"),W=document.getElementById("event-detail-group"),q=document.getElementById("event-detail-date"),J=document.getElementById("event-detail-time"),V=document.getElementById("event-detail-location");async function Y(){h=C.innerHTML,k.addEventListener("click",Ae),$.addEventListener("click",Be),C.addEventListener("click",Se),b.addEventListener("click",Ee),M.addEventListener("click",()=>pe("daily")),x.addEventListener("click",()=>pe("weekly")),T.addEventListener("click",Le),H.addEventListener("click",e=>e.stopPropagation()),P.addEventListener("click",Le),G.addEventListener("click",ke),j.addEventListener("click",ke),F.addEventListener("click",e=>e.stopPropagation()),A.addEventListener("click",be),O.addEventListener("click",e=>e.stopPropagation()),N.addEventListener("click",be),I.addEventListener("touchstart",fe,!1),I.addEventListener("touchend",ye,!1),document.addEventListener("keydown",he),ee(),te();try{if(await le(),document.getElementById("loading-indicator").style.display="none",u.length>0){const e=u.reduce((e,t)=>{const n=new Date(e.sd.split("/").reverse().join("-"));return new Date(t.sd.split("/").reverse().join("-"))>n?t:e}),t=new Date;t.setHours(0,0,0,0);const n=new Date(e.sd.split("/").reverse().join("-"));maxDateOffset=Math.floor((n-t)/864e5)}else maxDateOffset=0;ne(),re(),ue(),me(),ge(),localStorage.getItem("calendarVisited")||A.classList.remove("hidden")}catch(e){document.getElementById("loading-indicator").innerText="Failed to load calendar data.",console.error("Failed to initialize calendar:",e)}}function _(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function z(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);const n=(16777215&t).toString(16).toUpperCase();return"#"+"00000".substring(0,6-n.length)+n}function X(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}function U(e){if("string"!=typeof e||!e.includes(":"))return null;const[t,n]=e.split(":").map(Number);return 60*t+n}function K(e){const t=String(e).padStart(6,"0");return`${t.substring(0,2)}/${t.substring(2,4)}/${"20"+t.substring(4,6)}`}function Q(e){const t=String(e).padStart(4,"0");return`${t.substring(0,2)}:${t.substring(2,4)}`}function Z(e){const{schema:t,events:n,meta:s}=e,o=s.c,a={};return t.forEach((e,t)=>{a[e]=t}),n.map(e=>{const t={sd:K(e[a.d]),st:Q(e[a.st]),et:Q(e[a.et]),g:o[e[a.g]],t:e[a.t],l:e[a.l]};return a.ed<e.length?t.ed=K(e[a.ed]):t.ed=t.sd,t})}function ee(){"true"===localStorage.getItem("sidebarCollapsed")&&L.classList.add("collapsed")}function te(){const e=localStorage.getItem("viewMode");if(e)w=e;else{const e=window.innerWidth<i;w=e?"daily":"weekly"}se()}function ne(){const e=document.getElementById("group-list");v=[...p.c].sort((e,t)=>{const n=["M2","M2_ANDROIDE"],s=["DEEP-L","RDFIA"],o=n.includes(e),a=n.includes(t),i=s.includes(e),c=s.includes(t);return o&&!a?-1:!o&&a?1:o&&a?n.indexOf(e)-n.indexOf(t):i&&!c?1:!i&&c?-1:i&&c?s.indexOf(e)-s.indexOf(t):e.localeCompare(t)});const t=JSON.parse(localStorage.getItem("selectedGroups")),n=v.filter(e=>!["DEEP-L","RDFIA"].includes(e));g=t||n,t||localStorage.setItem("selectedGroups",JSON.stringify(g)),v.forEach(t=>{m[t]=o[t]||z(t);const n=document.createElement("button");n.className="group-btn",n.textContent=t,n.dataset.group=t,n.style.backgroundColor=m[t],g.includes(t)||n.classList.add("inactive"),n.addEventListener("click",()=>{n.classList.toggle("inactive");const e=n.dataset.group;n.classList.contains("inactive")?g=g.filter(t=>t!==e):g.push(e),localStorage.setItem("selectedGroups",JSON.stringify(g)),ae(),re()}),e.appendChild(n)}),ae()}function se(){"weekly"===w?(x.classList.add("active"),M.classList.remove("active")):(M.classList.add("active"),x.classList.remove("active"))}function oe(){$.disabled=f<=0,C.disabled=f>=maxDateOffset;const e="weekly"===w?"Week":"Days";$.title=`Previous ${e} (←)`,C.title=`Next ${e} (→)`}function ae(){const e=document.getElementById("group-color-indicators");e.innerHTML="",v.forEach(t=>{const n=document.createElement("div");if(g.includes(t)){n.className="color-indicator";const e=m[t]||"#ccc";n.style.backgroundColor=e,n.style.setProperty("--glow-color",X(e,.7))}else n.className="color-indicator inactive";e.appendChild(n)})}function ie(){document.querySelectorAll(".current-time-line").forEach(e=>e.remove());const e=new Date,t=_(e),n=document.querySelector(`.day-column[data-date='${t}'] .timeline`);if(!n)return;const s=60*e.getHours()+e.getMinutes();if(s<360||s>1260)return;const o=(s-360)/60*xe(),a=document.createElement("div");a.className="current-time-line",a.style.top=`${o}px`,n.appendChild(a)}function ce(e,t){const n="weekly"===w&&window.innerWidth<i,s={weekday:n?void 0:"short",month:n?"numeric":"short",day:"numeric"};e.textContent=t.toLocaleDateString(void 0,s);const o=_(new Date);_(t)===o&&e.classList.add("today-header")}async function le(){const t=await de(e);u=Z(t),p=t.meta}async function de(e){const t=`${e}?t=${(new Date).getTime()}`,n=await fetch(t,{cache:"reload"});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}function re(){I.innerHTML="",I.classList.toggle("weekly-view","weekly"===w);const e="weekly"===w?6:2,t=new Date;t.setDate(t.getDate()+f);let n=new Date(t);if("weekly"===w){const e=n.getDay();if(0===e&&0===f){const e=n.getDate()+1;n.setDate(e)}else{const t=n.getDate()-e+(0===e?-6:1);n.setDate(t)}}for(let t=0;t<e;t++){const e=new Date(n);e.setDate(e.getDate()+t);const s=_(e),o=document.createElement("div");o.className="day-column",o.dataset.date=s;const a=document.createElement("div");a.className="day-header",ce(a,e);const i=document.createElement("div");i.className="timeline",$e(i),o.appendChild(a),o.appendChild(i),I.appendChild(o);Ce(u.filter(e=>{const t=e.sd.split("/").reverse().join("-");return g.includes(e.g)&&t===s}),i)}oe(),ie()}function ue(){const e=()=>{if(!p.ts)return;const e=new Date(p.ts),t=new Date,n=Math.round((t-e)/6e4);let s="";if(n<1)s="Last update: just now";else if(n<60)s=`Last update: ${n} minute${n>1?"s":""} ago`;else{const e=Math.floor(n/60);s=`Last update: ${e} hour${e>1?"s":""} ago`}S.textContent=s,B.textContent=s,Me()};e(),c&&clearInterval(c),c=setInterval(e,6e4)}function me(){ie(),l&&clearInterval(l),l=setInterval(ie,6e4)}function ge(){const e=document.querySelector(".current-time-line");e&&e.scrollIntoView({behavior:"smooth",block:"center"})}function pe(e){if(e===w)return;const t=new Date;t.setHours(0,0,0,0);let n=f;if("weekly"===e){const e=new Date;e.setDate(e.getDate()+f),e.setHours(0,0,0,0);const s=e.getDay(),o=e.getDate()-s+(0===s?-6:1),a=new Date(e.setDate(o));n=Math.round((a-t)/864e5)}else if("daily"===e){const e=new Date;e.setDate(e.getDate()+f);const s=e.getDay(),o=e.getDate()-s+(0===s?-6:1),a=new Date(e.setDate(o));let i=new Date(a);const c=[];for(let e=0;e<6;e++){const t=new Date(a);t.setDate(t.getDate()+e),c.push(t.toISOString().split("T")[0].split("-").reverse().join("/"))}const l=u.filter(e=>g.includes(e.g)&&c.includes(e.sd)).sort((e,t)=>e.sd.split("/").reverse().join("-").localeCompare(t.sd.split("/").reverse().join("-")));if(l.length>0){const[e,t,n]=l[0].sd.split("/");i=new Date(n,t-1,e)}n=Math.round((i-t)/864e5)}f=Math.max(0,Math.min(n,y)),w=e,localStorage.setItem("viewMode",e),se(),re()}function fe(e){const t=e.touches[0];d=t.clientX,r=t.clientY,E=(new Date).getTime()}function ye(e){const t=e.changedTouches[0],n=t.clientX,s=t.clientY,o=(new Date).getTime()-E,a=n-d,i=s-r;Math.abs(a)>.7*Math.abs(i)&&o<700&&Math.abs(a)>40&&(a<0?C.disabled||(Se(),we()):$.disabled||(Be(),we()))}function he(e){"ArrowRight"===e.key?C.disabled||(Se(),we()):"ArrowLeft"===e.key?$.disabled||(Be(),we()):"d"===e.key||"D"===e.key?pe("daily"):"w"===e.key||"W"===e.key?pe("weekly"):"Tab"===e.key?(e.preventDefault(),Ee()):" "===e.key?(e.preventDefault(),Ae()):"Escape"===e.key&&(Le(),ke(),be())}function ve(e){const t=v[e],n=document.querySelector(`[data-group="${t}"]`);n&&(n.classList.toggle("inactive"),n.classList.contains("inactive")?g=g.filter(e=>e!==t):g.push(t),localStorage.setItem("selectedGroups",JSON.stringify(g)),ae(),re())}function we(){const e=document.querySelectorAll(".day-header");e.forEach(e=>{e.classList.add("swiped")}),setTimeout(()=>{e.forEach(e=>{e.classList.remove("swiped")})},200)}function Ee(){const e=L.classList.contains("collapsed");L.classList.toggle("collapsed"),localStorage.setItem("sidebarCollapsed",L.classList.contains("collapsed")),e&&!L.classList.contains("collapsed")&&ke()}function De(){T.classList.remove("hidden")}function Le(){T.classList.add("hidden")}function be(){A.classList.add("hidden"),localStorage.setItem("calendarVisited","true")}function Ie(e,t){if(!e)return;const[n,s,o]=e.sd.split("/"),a=new Date(o,s-1,n);R.textContent=e.t,W.textContent=`Group: ${e.g}`,q.textContent=a.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),J.textContent=`${e.st} - ${e.et}`,V.textContent=e.l||"No location specified";const i=m[e.g]||"#888";if(F.style.borderTopColor=i,W.style.color=i,t){const e=t.getBoundingClientRect(),n=320,s=200,o=L.classList.contains("collapsed")?15:160,a=window.innerWidth-o,i=L.classList.contains("collapsed")?window.innerWidth:a;let c=e.right+10,l=e.top;c+n>i&&(c=e.left-n-10,c<10&&(c=Math.max(10,(i-n)/2),!L.classList.contains("collapsed")&&c+n>a&&(Ee(),c=(window.innerWidth-n)/2))),c<10&&(c=10),l+s>window.innerHeight&&(l=window.innerHeight-s-10),l<10&&(l=10),F.style.left=`${c}px`,F.style.top=`${l}px`}j.classList.remove("hidden"),F.classList.remove("hidden"),requestAnimationFrame(()=>{F.style.transform="scale(1)"})}function ke(){j.classList.add("hidden"),F.classList.add("hidden"),F.style.transform="scale(0.9)"}function Me(){if(!p.ts)return;const e=new Date(p.ts);(new Date-e)/36e5>a?(S.classList.add("stale-data"),B.classList.add("stale-data"),D||(De(),D=!0)):(S.classList.remove("stale-data"),B.classList.remove("stale-data"),D=!1)}function xe(){const e=window.innerHeight-41;return Math.max(s,e/15)}function $e(e){const t=xe(),s=15*t;e.style.height=`${s}px`;for(let s=6;s<=n;s++){const o=(s-6)*t,a=document.createElement("div");if(a.className="hour-line",a.style.top=`${o}px`,e.appendChild(a),s>6&&s<n){const t=document.createElement("div");t.className="hour-label",t.textContent=`${s}:00`,t.style.top=`${o}px`,e.appendChild(t)}}}function Ce(e,t){if(!e.length)return;const n=xe(),s=e.map(e=>{const t=U(e.st),s=U(e.et);return null===t||null===s||s<=t?null:{...e,startMinutes:t,endMinutes:s,top:(t-360)/60*n,height:(s-t)/60*n}}).filter(Boolean).sort((e,t)=>e.startMinutes-t.startMinutes),o=[];if(s.length>0){let e=[s[0]];o.push(e);let t=s[0].endMinutes;for(let n=1;n<s.length;n++){const a=s[n];a.startMinutes>=t?(e=[a],o.push(e),t=a.endMinutes):(e.push(a),t=Math.max(t,a.endMinutes))}}for(const e of o){e.sort((e,t)=>e.startMinutes-t.startMinutes);const t=[];for(const n of e){let e=!1;for(const s of t)if(n.startMinutes>=s[s.length-1].endMinutes){s.push(n),n.colIndex=t.indexOf(s),e=!0;break}e||(t.push([n]),n.colIndex=t.length-1)}for(const n of e)n.totalColumns=t.length}for(const e of s){const n=document.createElement("div");n.className="event-block";const s=100/e.totalColumns;n.style.width=`calc(${s}% - 5px)`,n.style.left=e.colIndex*s+"%",n.style.top=`${e.top}px`,n.style.height=`${Math.max(20,e.height-2)}px`;const o=m[e.g]||"#ccc";n.style.backgroundColor=X(o,.5),n.style.borderColor=o,n.style.setProperty("--glow-color",X(o,.7));if("weekly"===w&&window.innerWidth<i){const t=(e.l||"N/A").split("").join("<br>");n.innerHTML=`<p class="event-title">${t}</p>`,n.style.fontSize="10px",n.style.lineHeight="1.1",n.style.textAlign="center",n.style.padding="4px 2px"}else n.innerHTML=`<p class="event-title">${e.t}</p><p>${e.st} - ${e.et}</p><p>${e.l}</p>`;n.addEventListener("click",t=>{t.stopPropagation(),Ie(e,n)}),t.appendChild(n)}}function Se(){f+="weekly"===w?7:2,ke(),re()}function Be(){f-="weekly"===w?7:2,ke(),re()}function Ae(){f=0,re(),ge()}document.addEventListener("visibilitychange",async function(){if("visible"===document.visibilityState)try{await le(),re(),ue(),ie()}catch(e){console.error("Failed to refresh calendar data:",e)}});