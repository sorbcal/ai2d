document.addEventListener("DOMContentLoaded",X);const e="https://gist.githubusercontent.com/Thomas-Marchand/427d44e917d26d6073378d81db84d5b2/raw/calendar_events.json",t=6,n=21,s=60,o={M2:"#eb0909",M2_ANDROIDE:"#bf1e9a",MOSIMA:"#83d45b","AI-ADAPT":"#3498db",COCOMA:"#becc29",MADMC:"#f1c40f",MAOA:"#e67e22",AOTJ:"#e74c3c",MADI:"#ff365a",HAII:"#b368de",IAR:"#1f804f","OIP Gr1":"#ab1f8d","OIP Gr2":"#ab1f9d","OIP Gr3":"#ab1fad","DEEP-L":"#16304a",RDFIA:"#0b5345"},a=24,i=680;let c,l,d,r,u=[],m={},p=[],g={},f=0,y=0,h="",v=[],w="daily",E=0,L=!1;const D=document.getElementById("sidebar"),b=document.getElementById("sidebar-toggle-btn"),I=document.querySelector(".calendar-container"),k=document.getElementById("today-btn"),M=document.getElementById("daily-view-btn"),x=document.getElementById("weekly-view-btn"),$=document.getElementById("prev-btn"),C=document.getElementById("next-btn"),S=document.getElementById("last-updated"),B=document.getElementById("collapsed-sidebar-info"),A=document.getElementById("instruction-popup-overlay"),O=document.getElementById("instruction-popup-box"),N=document.getElementById("instruction-popup-close-btn"),T=document.getElementById("eos-popup-overlay"),P=document.getElementById("eos-popup-box"),H=document.getElementById("eos-popup-close-btn"),j=document.getElementById("stale-popup-overlay"),F=document.getElementById("stale-popup-box"),G=document.getElementById("stale-popup-close-btn"),R=document.getElementById("event-detail-overlay"),q=document.getElementById("event-detail-box"),W=document.getElementById("event-detail-close-btn"),J=document.getElementById("event-detail-title"),V=document.getElementById("event-detail-group"),Y=document.getElementById("event-detail-date"),_=document.getElementById("event-detail-time"),z=document.getElementById("event-detail-location");async function X(){h=C.innerHTML,k.addEventListener("click",He),$.addEventListener("click",Pe),C.addEventListener("click",Te),b.addEventListener("click",be),M.addEventListener("click",()=>he("daily")),x.addEventListener("click",()=>he("weekly")),T.addEventListener("click",ke),P.addEventListener("click",e=>e.stopPropagation()),H.addEventListener("click",ke),j.addEventListener("click",xe),F.addEventListener("click",e=>e.stopPropagation()),G.addEventListener("click",xe),W.addEventListener("click",Se),R.addEventListener("click",Se),q.addEventListener("click",e=>e.stopPropagation()),A.addEventListener("click",$e),O.addEventListener("click",e=>e.stopPropagation()),N.addEventListener("click",$e),I.addEventListener("touchstart",ve,!1),I.addEventListener("touchend",we,!1),document.addEventListener("keydown",Ee),se(),oe(),Ie();try{if(await ue(),document.getElementById("loading-indicator").style.display="none",u.length>0){const e=u.reduce((e,t)=>{const n=new Date(e.sd.split("/").reverse().join("-"));return new Date(t.sd.split("/").reverse().join("-"))>n?t:e}),t=new Date;t.setHours(0,0,0,0);const n=new Date(e.sd.split("/").reverse().join("-"));maxDateOffset=Math.floor((n-t)/864e5)}else maxDateOffset=0;ae(),pe(),ge(),fe(),ye(),localStorage.getItem("calendarVisited")||A.classList.remove("hidden")}catch(e){document.getElementById("loading-indicator").innerText="Failed to load calendar data.",console.error("Failed to initialize calendar:",e)}}function U(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function K(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);const n=(16777215&t).toString(16).toUpperCase();return"#"+"00000".substring(0,6-n.length)+n}function Q(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}function Z(e){if("string"!=typeof e||!e.includes(":"))return null;const[t,n]=e.split(":").map(Number);return 60*t+n}function ee(e){const t=String(e).padStart(6,"0");return`${t.substring(0,2)}/${t.substring(2,4)}/${"20"+t.substring(4,6)}`}function te(e){const t=String(e).padStart(4,"0");return`${t.substring(0,2)}:${t.substring(2,4)}`}function ne(e){const{schema:t,events:n,meta:s}=e,o=s.c,a={};return t.forEach((e,t)=>{a[e]=t}),n.map(e=>{const t={sd:ee(e[a.d]),st:te(e[a.st]),et:te(e[a.et]),g:o[e[a.g]],t:e[a.t],l:e[a.l]};return a.ed<e.length?t.ed=ee(e[a.ed]):t.ed=t.sd,t})}function se(){"true"===localStorage.getItem("sidebarCollapsed")&&D.classList.add("collapsed")}function oe(){const e=localStorage.getItem("viewMode");if(e)w=e;else{const e=window.innerWidth<i;w=e?"daily":"weekly"}ie()}function ae(){const e=document.getElementById("group-list");v=[...g.c].sort((e,t)=>{const n=["M2","M2_ANDROIDE"],s=["DEEP-L","RDFIA"],o=n.includes(e),a=n.includes(t),i=s.includes(e),c=s.includes(t);return o&&!a?-1:!o&&a?1:o&&a?n.indexOf(e)-n.indexOf(t):i&&!c?1:!i&&c?-1:i&&c?s.indexOf(e)-s.indexOf(t):e.localeCompare(t)});const t=JSON.parse(localStorage.getItem("selectedGroups")),n=v.filter(e=>!["DEEP-L","RDFIA"].includes(e));p=t||n,t||localStorage.setItem("selectedGroups",JSON.stringify(p)),v.forEach(t=>{m[t]=o[t]||K(t);const n=document.createElement("button");n.className="group-btn",n.textContent=t,n.dataset.group=t,n.style.backgroundColor=m[t],p.includes(t)||n.classList.add("inactive"),n.addEventListener("click",()=>{n.classList.toggle("inactive");const e=n.dataset.group;n.classList.contains("inactive")?p=p.filter(t=>t!==e):p.push(e),localStorage.setItem("selectedGroups",JSON.stringify(p)),le(),pe()}),e.appendChild(n)}),le()}function ie(){"weekly"===w?(x.classList.add("active"),M.classList.remove("active")):(M.classList.add("active"),x.classList.remove("active"))}function ce(){$.disabled=f<=0,C.disabled=f>=maxDateOffset;const e="weekly"===w?"Week":"Days";$.title=`Previous ${e} (←)`,C.title=`Next ${e} (→)`}function le(){const e=document.getElementById("group-color-indicators");e.innerHTML="",v.forEach(t=>{const n=document.createElement("div");if(p.includes(t)){n.className="color-indicator";const e=m[t]||"#ccc";n.style.backgroundColor=e,n.style.setProperty("--glow-color",Q(e,.7))}else n.className="color-indicator inactive";e.appendChild(n)})}function de(){document.querySelectorAll(".current-time-line").forEach(e=>e.remove());const e=new Date,t=U(e),n=document.querySelector(`.day-column[data-date='${t}'] .timeline`);if(!n)return;const s=60*e.getHours()+e.getMinutes();if(s<360||s>1260)return;const o=(s-360)/60*Ae(),a=document.createElement("div");a.className="current-time-line",a.style.top=`${o}px`,n.appendChild(a)}function re(e,t){const n="weekly"===w&&window.innerWidth<i,s={weekday:n?void 0:"short",month:n?"numeric":"short",day:"numeric"};e.textContent=t.toLocaleDateString(void 0,s);const o=U(new Date);U(t)===o&&e.classList.add("today-header")}async function ue(){const t=await me(e);u=ne(t),g=t.meta}async function me(e){const t=`${e}?t=${(new Date).getTime()}`,n=await fetch(t,{cache:"reload"});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}function pe(){I.innerHTML="",I.classList.toggle("weekly-view","weekly"===w);const e="weekly"===w?6:2,t=new Date;t.setDate(t.getDate()+f);let n=new Date(t);if("weekly"===w){const e=n.getDay();if(0===e&&0===f){const e=n.getDate()+1;n.setDate(e)}else{const t=n.getDate()-e+(0===e?-6:1);n.setDate(t)}}for(let t=0;t<e;t++){const e=new Date(n);e.setDate(e.getDate()+t);const s=U(e),o=document.createElement("div");o.className="day-column",o.dataset.date=s;const a=document.createElement("div");a.className="day-header",re(a,e);const i=document.createElement("div");i.className="timeline",Oe(i),o.appendChild(a),o.appendChild(i),I.appendChild(o);Ne(u.filter(e=>{const t=e.sd.split("/").reverse().join("-");return p.includes(e.g)&&t===s}),i)}ce(),de()}function ge(){const e=()=>{if(!g.ts)return;const e=new Date(g.ts),t=new Date,n=Math.round((t-e)/6e4);let s="";if(n<1)s="Last update: just now";else if(n<60)s=`Last update: ${n} minute${n>1?"s":""} ago`;else{const e=Math.floor(n/60);s=`Last update: ${e} hour${e>1?"s":""} ago`}S.textContent=s,B.textContent=s,Be()};e(),c&&clearInterval(c),c=setInterval(e,6e4)}function fe(){de(),l&&clearInterval(l),l=setInterval(de,6e4)}function ye(){const e=document.querySelector(".current-time-line");e&&e.scrollIntoView({behavior:"smooth",block:"center"})}function he(e){if(e===w)return;const t=new Date;t.setHours(0,0,0,0);let n=f;if("weekly"===e){const e=new Date;e.setDate(e.getDate()+f),e.setHours(0,0,0,0);const s=e.getDay(),o=e.getDate()-s+(0===s?-6:1),a=new Date(e.setDate(o));n=Math.round((a-t)/864e5)}else if("daily"===e){const e=new Date;e.setDate(e.getDate()+f);const s=e.getDay(),o=e.getDate()-s+(0===s?-6:1),a=new Date(e.setDate(o));let i=new Date(a);const c=[];for(let e=0;e<6;e++){const t=new Date(a);t.setDate(t.getDate()+e),c.push(t.toISOString().split("T")[0].split("-").reverse().join("/"))}const l=u.filter(e=>p.includes(e.g)&&c.includes(e.sd)).sort((e,t)=>e.sd.split("/").reverse().join("-").localeCompare(t.sd.split("/").reverse().join("-")));if(l.length>0){const[e,t,n]=l[0].sd.split("/");i=new Date(n,t-1,e)}n=Math.round((i-t)/864e5)}f=Math.max(0,Math.min(n,y)),w=e,localStorage.setItem("viewMode",e),ie(),pe()}function ve(e){const t=e.touches[0];d=t.clientX,r=t.clientY,E=(new Date).getTime()}function we(e){const t=e.changedTouches[0],n=t.clientX,s=t.clientY,o=(new Date).getTime()-E,a=n-d,i=s-r;Math.abs(a)>.7*Math.abs(i)&&o<700&&Math.abs(a)>40&&(a<0?C.disabled||(Te(),De()):$.disabled||(Pe(),De()))}function Ee(e){"ArrowRight"===e.key?C.disabled||(Te(),De()):"ArrowLeft"===e.key?$.disabled||(Pe(),De()):"d"===e.key||"D"===e.key?he("daily"):"w"===e.key||"W"===e.key?he("weekly"):"Tab"===e.key?(e.preventDefault(),be()):" "===e.key?(e.preventDefault(),He()):"Escape"===e.key&&(xe(),Se(),$e())}function Le(e){const t=v[e],n=document.querySelector(`[data-group="${t}"]`);n&&(n.classList.toggle("inactive"),n.classList.contains("inactive")?p=p.filter(e=>e!==t):p.push(t),localStorage.setItem("selectedGroups",JSON.stringify(p)),le(),pe())}function De(){const e=document.querySelectorAll(".day-header");e.forEach(e=>{e.classList.add("swiped")}),setTimeout(()=>{e.forEach(e=>{e.classList.remove("swiped")})},200)}function be(){const e=D.classList.contains("collapsed");D.classList.toggle("collapsed"),localStorage.setItem("sidebarCollapsed",D.classList.contains("collapsed")),e&&!D.classList.contains("collapsed")&&Se()}function Ie(){T.classList.remove("hidden")}function ke(){T.classList.add("hidden")}function Me(){j.classList.remove("hidden")}function xe(){j.classList.add("hidden")}function $e(){A.classList.add("hidden"),localStorage.setItem("calendarVisited","true")}function Ce(e,t){if(!e)return;const[n,s,o]=e.sd.split("/"),a=new Date(o,s-1,n);J.textContent=e.t,V.textContent=`Group: ${e.g}`,Y.textContent=a.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),_.textContent=`${e.st} - ${e.et}`,z.textContent=e.l||"No location specified";const i=m[e.g]||"#888";if(q.style.borderTopColor=i,V.style.color=i,t){const e=t.getBoundingClientRect(),n=320,s=200;let o=e.right+10,a=e.top;o+n>window.innerWidth&&(o=e.left-n-10),o<10&&(o=10),a+s>window.innerHeight&&(a=window.innerHeight-s-10),a<10&&(a=10);const i=D.classList.contains("collapsed")?15:160,c=window.innerWidth-i;!D.classList.contains("collapsed")&&o+n>c&&be(),q.style.left=`${o}px`,q.style.top=`${a}px`}R.classList.remove("hidden"),q.classList.remove("hidden"),requestAnimationFrame(()=>{q.style.transform="scale(1)"})}function Se(){R.classList.add("hidden"),q.classList.add("hidden"),q.style.transform="scale(0.9)"}function Be(){if(!g.ts)return;const e=new Date(g.ts);(new Date-e)/36e5>a?(S.classList.add("stale-data"),B.classList.add("stale-data"),L||(Me(),L=!0)):(S.classList.remove("stale-data"),B.classList.remove("stale-data"),L&&xe(),L=!1)}function Ae(){const e=window.innerHeight-41;return Math.max(s,e/15)}function Oe(e){const t=Ae(),s=15*t;e.style.height=`${s}px`;for(let s=6;s<=n;s++){const o=(s-6)*t,a=document.createElement("div");if(a.className="hour-line",a.style.top=`${o}px`,e.appendChild(a),s>6&&s<n){const t=document.createElement("div");t.className="hour-label",t.textContent=`${s}:00`,t.style.top=`${o}px`,e.appendChild(t)}}}function Ne(e,t){if(!e.length)return;const n=Ae(),s=e.map(e=>{const t=Z(e.st),s=Z(e.et);return null===t||null===s||s<=t?null:{...e,startMinutes:t,endMinutes:s,top:(t-360)/60*n,height:(s-t)/60*n}}).filter(Boolean).sort((e,t)=>e.startMinutes-t.startMinutes),o=[];if(s.length>0){let e=[s[0]];o.push(e);let t=s[0].endMinutes;for(let n=1;n<s.length;n++){const a=s[n];a.startMinutes>=t?(e=[a],o.push(e),t=a.endMinutes):(e.push(a),t=Math.max(t,a.endMinutes))}}for(const e of o){e.sort((e,t)=>e.startMinutes-t.startMinutes);const t=[];for(const n of e){let e=!1;for(const s of t)if(n.startMinutes>=s[s.length-1].endMinutes){s.push(n),n.colIndex=t.indexOf(s),e=!0;break}e||(t.push([n]),n.colIndex=t.length-1)}for(const n of e)n.totalColumns=t.length}for(const e of s){const n=document.createElement("div");n.className="event-block";const s=100/e.totalColumns;n.style.width=`calc(${s}% - 5px)`,n.style.left=e.colIndex*s+"%",n.style.top=`${e.top}px`,n.style.height=`${Math.max(20,e.height-2)}px`;const o=m[e.g]||"#ccc";n.style.backgroundColor=Q(o,.5),n.style.borderColor=o,n.style.setProperty("--glow-color",Q(o,.7));if("weekly"===w&&window.innerWidth<i){const t=(e.l||"N/A").split("").join("<br>");n.innerHTML=`<p class="event-title">${t}</p>`,n.style.fontSize="10px",n.style.lineHeight="1.1",n.style.textAlign="center",n.style.padding="4px 2px"}else n.innerHTML=`<p class="event-title">${e.t}</p><p>${e.st} - ${e.et}</p><p>${e.l}</p>`;n.addEventListener("click",t=>{t.stopPropagation(),Ce(e,n)}),t.appendChild(n)}}function Te(){f+="weekly"===w?7:2,Se(),pe()}function Pe(){f-="weekly"===w?7:2,Se(),pe()}function He(){f=0,pe(),ye()}document.addEventListener("visibilitychange",async function(){if("visible"===document.visibilityState)try{await ue(),pe(),ge(),de()}catch(e){console.error("Failed to refresh calendar data:",e)}});